package v3

import (
	"math/big"
	"strings"

	"github.com/ethereum/go-ethereum/accounts/abi"
	"github.com/ethereum/go-ethereum/common"
	"github.com/ethereum/go-ethereum/core"
	"github.com/ethereum/go-ethereum/core/state"
	"github.com/ethereum/go-ethereum/core/types"
	"github.com/ethereum/go-ethereum/log"
	"github.com/ethereum/go-ethereum/params"
)

var (
	punishContractName = "punish_v3"
	punishContractAddr = common.HexToAddress("0x000000000000000000000000000000000000F006")
	punishCode         = "0x608060405234801561001057600080fd5b50600436106101585760003560e01c8063741579b1116100c3578063d93d2cb91161007c578063d93d2cb9146102ca578063e0d8ea53146102e7578063ea7221a1146102ef578063ec0cb336146101c1578063f3b1cc6714610315578063f62af26c1461031d57610158565b8063741579b11461026e5780638129fc1c146102765780639001eed81461027e578063c967f90f14610286578063cb1ea725146102a5578063cfe9f8ec146102ad57610158565b806332f3c17f1161011557806332f3c17f146101d157806344c1aa99146101f757806344f99900146101ff5780634b0b32c51461022357806363e1d4511461024057806371a1bb751461026657610158565b806301036cae1461015d57806303fab4f61461018b578063158ef93e146101a557806315de360e146101c15780632897183d146101c95780632e4f67e4146101c1575b600080fd5b6101896004803603604081101561017357600080fd5b50803590602001356001600160a01b031661033a565b005b6101936105ef565b60408051918252519081900360200190f35b6101ad6105fc565b604080519115158252519081900360200190f35b610193610605565b61019361060c565b610193600480360360208110156101e757600080fd5b50356001600160a01b0316610612565b61019361062d565b610207610633565b604080516001600160a01b039092168252519081900360200190f35b6101ad6004803603602081101561023957600080fd5b5035610639565b6101896004803603602081101561025657600080fd5b50356001600160a01b031661064e565b6102076108f0565b6101936108f6565b610189610902565b610193610971565b61028e61097f565b6040805161ffff9092168252519081900360200190f35b610193610984565b6101ad600480360360208110156102c357600080fd5b503561098a565b610189600480360360208110156102e057600080fd5b503561099f565b610193610c42565b6101896004803603602081101561030557600080fd5b50356001600160a01b0316610c48565b610193611040565b6102076004803603602081101561033357600080fd5b5035611047565b33411461037b576040805162461bcd60e51b815260206004820152600a6024820152694d696e6572206f6e6c7960b01b604482015290519081900360640190fd5b60005460ff166103c1576040805162461bcd60e51b815260206004820152600c60248201526b139bdd081a5b9a5d081e595d60a21b604482015290519081900360640190fd5b600082815260086020526040902054829060ff161561041a576040805162461bcd60e51b815260206004820152601060248201526f105b1c9958591e481c1d5b9a5cda195960821b604482015290519081900360640190fd5b600061f0056001600160a01b03166365f69f97846040518263ffffffff1660e01b815260040180826001600160a01b0316815260200191505060206040518083038186803b15801561046b57600080fd5b505afa15801561047f573d6000803e3d6000fd5b505050506040513d602081101561049557600080fd5b505190506001600160a01b0381166104ea576040805162461bcd60e51b81526020600482015260136024820152721d985b1a59185d1bdc881b9bdd08199bdd5b99606a1b604482015290519081900360640190fd5b806001600160a01b031663826d3dec6040518163ffffffff1660e01b8152600401600060405180830381600087803b15801561052557600080fd5b505af1158015610539573d6000803e3d6000fd5b50505050806001600160a01b031663ba26d9ff6040518163ffffffff1660e01b8152600401600060405180830381600087803b15801561057857600080fd5b505af115801561058c573d6000803e3d6000fd5b505050600085815260086020908152604091829020805460ff19166001179055815142815291516001600160a01b03871693507fda5de20b8278e154fa3f60bbee4cf3f2f8b00c704fcc1042929f222d499a24949281900390910190a250505050565b68056bc75e2d6310000081565b60005460ff1681565b6201518081565b60035481565b6001600160a01b031660009081526004602052604090205490565b60025481565b61f00681565b60009081526008602052604090205460ff1690565b60005460ff16610694576040805162461bcd60e51b815260206004820152600c60248201526b139bdd081a5b9a5d081e595d60a21b604482015290519081900360640190fd5b604080516365f69f9760e01b81526001600160a01b03831660048201529051339161f005916365f69f9791602480820192602092909190829003018186803b1580156106df57600080fd5b505afa1580156106f3573d6000803e3d6000fd5b505050506040513d602081101561070957600080fd5b50516001600160a01b031614610766576040805162461bcd60e51b815260206004820152601860248201527f56616c696461746f72206e6f7420726567697374657265640000000000000000604482015290519081900360640190fd5b6001600160a01b0381166000908152600460205260409020541561079e576001600160a01b0381166000908152600460205260408120555b6001600160a01b03811660009081526004602052604090206002015460ff1680156107ca575060055415155b156108ed576005546001600160a01b03821660009081526004602052604090206001015460001990910114610894576005805460009190600019810190811061080f57fe5b60009182526020808320909101546001600160a01b038581168452600490925260409092206001015460058054929093169350839291811061084d57fe5b600091825260208083209190910180546001600160a01b0319166001600160a01b039485161790558483168252600490526040808220600190810154949093168252902001555b600580548061089f57fe5b60008281526020808220830160001990810180546001600160a01b03191690559092019092556001600160a01b038316825260049052604081206001810191909155600201805460ff191690555b50565b61f00581565b670de0b6b3a764000081565b60005460ff1615610950576040805162461bcd60e51b8152602060048201526013602482015272105b1c9958591e481a5b9a5d1a585b1a5e9959606a1b604482015290519081900360640190fd5b6018600181815560306002556003919091556000805460ff19169091179055565b69010f0cf064dd5920000081565b601581565b60015481565b60086020526000908152604090205460ff1681565b3341146109e0576040805162461bcd60e51b815260206004820152600a6024820152694d696e6572206f6e6c7960b01b604482015290519081900360640190fd5b4360009081526007602052604090205460ff1615610a39576040805162461bcd60e51b8152602060048201526011602482015270105b1c9958591e48191958dc99585cd959607a1b604482015290519081900360640190fd5b60005460ff16610a7f576040805162461bcd60e51b815260206004820152600c60248201526b139bdd081a5b9a5d081e595d60a21b604482015290519081900360640190fd5b80804381610a8957fe5b0615610acf576040805162461bcd60e51b815260206004820152601060248201526f426c6f636b2065706f6368206f6e6c7960801b604482015290519081900360640190fd5b436000908152600760205260409020805460ff19166001179055600554610af557610c3e565b60005b600554811015610c135760035460025481610b0f57fe5b046004600060058481548110610b2157fe5b60009182526020808320909101546001600160a01b031683528201929092526040019020541115610bd25760035460025481610b5957fe5b046004600060058481548110610b6b57fe5b60009182526020808320909101546001600160a01b03168352820192909252604001812054600580549390910392600492919085908110610ba857fe5b60009182526020808320909101546001600160a01b03168352820192909252604001902055610c0b565b60006004600060058481548110610be557fe5b60009182526020808320909101546001600160a01b031683528201929092526040019020555b600101610af8565b506040517f181d51be54e8e8eaca6eae0eab32d4162099236bd519e7238d015d0870db464190600090a15b5050565b60055490565b334114610c89576040805162461bcd60e51b815260206004820152600a6024820152694d696e6572206f6e6c7960b01b604482015290519081900360640190fd5b60005460ff16610ccf576040805162461bcd60e51b815260206004820152600c60248201526b139bdd081a5b9a5d081e595d60a21b604482015290519081900360640190fd5b4360009081526006602052604090205460ff1615610d27576040805162461bcd60e51b815260206004820152601060248201526f105b1c9958591e481c1d5b9a5cda195960821b604482015290519081900360640190fd5b436000908152600660209081526040808320805460ff191660011790556001600160a01b0384168352600490915290206002015460ff16610dd057600580546001600160a01b038316600081815260046020526040812060018082018590558085019095557f036b6384b5eca791c62761152d0c79bb0604c104a5fb6f4eb0703f3154bb3db090930180546001600160a01b0319168317905552600201805460ff191690911790555b6001600160a01b03811660009081526004602052604090208054600101908190556002549081610dfc57fe5b06610efa57600061f0056001600160a01b03166365f69f97836040518263ffffffff1660e01b815260040180826001600160a01b0316815260200191505060206040518083038186803b158015610e5257600080fd5b505afa158015610e66573d6000803e3d6000fd5b505050506040513d6020811015610e7c57600080fd5b50516040805163209b4f7b60e21b815290519192506001600160a01b0383169163826d3dec9160048082019260009290919082900301818387803b158015610ec357600080fd5b505af1158015610ed7573d6000803e3d6000fd5b505050506001600160a01b03821660009081526004602052604081205550610ffe565b6001546001600160a01b03821660009081526004602052604090205481610f1d57fe5b06610ffe57600061f0056001600160a01b03166365f69f97836040518263ffffffff1660e01b815260040180826001600160a01b0316815260200191505060206040518083038186803b158015610f7357600080fd5b505afa158015610f87573d6000803e3d6000fd5b505050506040513d6020811015610f9d57600080fd5b50516040805163ba26d9ff60e01b815290519192506001600160a01b0383169163ba26d9ff9160048082019260009290919082900301818387803b158015610fe457600080fd5b505af1158015610ff8573d6000803e3d6000fd5b50505050505b6040805142815290516001600160a01b038316917f770e0cca42c35d00240986ce8d3ed438be04663c91dac6576b79537d7c180f1e919081900360200190a250565b6206270081565b6005818154811061105457fe5b6000918252602090912001546001600160a01b031690508156fea264697066735822122085104b2b516e4b9fd97ee9192606f76dd4d5498c3934d8134108cdde4cda885a64736f6c634300060c0033"
	punishAbi          abi.ABI
)

const PunishInteractiveABI = `[
    {
      "inputs": [
        {
          "internalType": "bytes32",
          "name": "punishHash",
          "type": "bytes32"
        },
        {
          "internalType": "address",
          "name": "val",
          "type": "address"
        }
      ],
      "name": "doubleSignPunish",
      "outputs": [],
      "stateMutability": "nonpayable",
      "type": "function"
    },
	{
      "inputs": [
        {
          "internalType": "bytes32",
          "name": "punishHash",
          "type": "bytes32"
        }
      ],
      "name": "isDoubleSignPunished",
      "outputs": [
        {
          "internalType": "bool",
          "name": "",
          "type": "bool"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    }
]`

func init() {
	punishAbi, _ = abi.JSON(strings.NewReader(PunishInteractiveABI))
}

func GetPunishContractName() string {
	return punishContractName
}

func GetPunishContractAddr() common.Address {
	return punishContractAddr
}

func GetPunishContractCode() string {
	return punishCode
}

func GetPunishContractAbi() abi.ABI {
	return punishAbi
}

type HardForkPunish struct {
}

func (s *HardForkPunish) GetName() string {
	return punishContractName
}

func (s *HardForkPunish) Update(config *params.ChainConfig, height *big.Int, state *state.StateDB) (err error) {
	contractCode := common.FromHex(punishCode)

	//write code to sys contract
	state.SetCode(punishContractAddr, contractCode)
	log.Debug("Write code to system contract account", "addr", punishContractAddr.String(), "code", punishCode)

	return
}

func (s *HardForkPunish) Execute(state *state.StateDB, header *types.Header, chainContext core.ChainContext, config *params.ChainConfig) (err error) {
	return
}
